<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bhasha-Buddy | Multilingual Language Reader</title>
    <meta name="description"
        content="A premium language learning tool to read and translate any language into Malayalam and English instantly. Support for PDFs and multiple source languages.">
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tiro+Devanagari+Hindi:ital@0;1&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Meera&display=swap"
        rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- PWA Meta Tags -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#6c5ce7">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon-192.png">

    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --text-main: #2d3436;
            --hindi-font: 'Tiro Devanagari Hindi', serif;
            --malayalam-font: 'Meera', sans-serif;
            --sidebar-width: 380px;
            --toolbar-height: 56px;
            --bg-dark: #323639;
            --bg-canvas: #525659;
            --accent: #6c5ce7;
        }

        body,
        html {
            height: 100%;
            margin: 0;
            overflow: hidden;
            overflow-x: hidden;
            font-family: 'Inter', sans-serif;
            background: var(--bg-canvas);
        }

        /* App Layout Container */
        #app-container {
            display: flex;
            height: 100vh;
            width: 100vw;
            overflow-x: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Sidebar - Input Zone */
        #sidebar {
            width: var(--sidebar-width);
            min-width: var(--sidebar-width);
            background: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #dee2e6;
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        }

        #sidebar.collapsed {
            margin-left: calc(-1 * var(--sidebar-width));
        }

        .sidebar-header {
            height: var(--toolbar-height);
            background: var(--primary-gradient);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1.25rem;
            flex-shrink: 0;
        }

        .brand-text {
            font-weight: 700;
            font-size: 1.25rem;
            letter-spacing: -0.5px;
        }

        .sidebar-content {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
        }

        /* Main Content - Reader Zone */
        #reader-zone {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            background: var(--bg-canvas);
        }

        /* Toolbar */
        .reader-toolbar {
            height: var(--toolbar-height);
            background: var(--bg-dark);
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 1rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            z-index: 900;
        }

        /* The scrolling area for the paper */
        #canvas-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 40px 20px;
            scroll-behavior: smooth;
        }

        /* The "Paper" */
        #reader-display {
            background: white;
            width: 100%;
            max-width: 900px;
            /* Slightly wider for better readability at large fonts */
            min-height: 1050px;
            /* Standard A4-ish ratio */
            height: auto;
            margin: 0 auto;
            /* Center horizontally in block layout */
            padding: 60px 80px;
            margin-bottom: 60px;
            /* Larger margin at bottom for scroll breathing room */
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            font-family: var(--hindi-font);
            font-size: 20px;
            line-height: 1.8;
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            /* Ensure no horizontal overflow */
            color: #202124;
            transition: font-size 0.2s ease, max-width 0.3s ease;
            position: relative;
            box-sizing: border-box;
            min-height: 200px;
            /* Smaller min-height for empty state */
        }

        /* PDF Render Styles */
        .pdf-page-wrapper {
            position: relative;
            margin: 40px auto;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: height 0.2s ease;
        }

        .pdf-page-container {
            position: relative;
            background: white;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
            line-height: 0;
            overflow: visible;
        }

        .page-badge {
            background: #636e72;
            color: white;
            padding: 4px 16px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            user-select: none;
        }

        .pdf-page-container canvas {
            display: block;
            max-width: 100%;
            height: auto !important;
        }

        .textLayer {
            opacity: 1;
            mix-blend-mode: multiply;
            /* Prevent mobile browsers from "inflating" font sizes which breaks selection alignment */
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
        }

        .textLayer ::selection {
            background: rgba(255, 234, 167, 0.6);
            color: transparent;
        }

        #reader-display.pdf-mode {
            background: transparent;
            box-shadow: none;
            padding: 0;
            width: auto;
            max-width: 100%;
            text-align: center;
        }

        #reader-display::selection {
            background: #ffeaa7;
            color: #d63031;
        }

        /* Sidebar Toggle - Moved to Toolbar */
        #toolbar-sidebar-toggle {
            display: none;
            /* Only show when sidebar is hidden */
            margin-right: 15px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            width: 38px;
            height: 38px;
            border-radius: 8px;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        #toolbar-sidebar-toggle:hover {
            transform: scale(1.05);
        }

        #toolbar-sidebar-toggle.visible {
            display: flex;
        }

        /* Footer & Social Icons */
        footer {
            padding: 1.5rem 0;
            border-top: 1px solid #eee;
            background: #fff;
            flex-shrink: 0;
        }

        .social-icon {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: #f8f9fa;
            color: #636e72;
            text-decoration: none;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            font-size: 1.1rem;
        }

        .social-icon:hover {
            background: var(--primary-gradient);
            color: white;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(118, 75, 162, 0.3);
        }

        .portfolio-link {
            color: var(--accent);
            text-decoration: none;
            font-weight: 600;
            font-size: 0.85rem;
            transition: opacity 0.2s;
        }

        .portfolio-link:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        /* Offline Alert Styles */
        #offline-alert {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: #d63031;
            color: white;
            padding: 8px 24px;
            border-radius: 50px;
            font-size: 0.9rem;
            font-weight: 600;
            z-index: 3000;
            display: none;
            box-shadow: 0 4px 15px rgba(214, 48, 49, 0.4);
            align-items: center;
        }

        #offline-alert i {
            margin-right: 10px;
        }

        /* Speech Synthesis Button */
        .btn-speak {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 1.1rem;
            margin-left: 8px;
            cursor: pointer;
            transition: transform 0.2s, color 0.2s;
            vertical-align: middle;
            padding: 0;
            line-height: 1;
        }

        .btn-speak:hover {
            transform: scale(1.2);
            color: #4834d4;
        }

        .btn-speak:active {
            transform: scale(0.9);
        }

        /* UI Elements */
        textarea#hindi-input {
            font-family: var(--hindi-font);
            font-size: 1.1rem;
            border: 1px solid #ced4da;
            border-radius: 8px;
            resize: none;
            height: 250px;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        textarea#hindi-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        }

        .input-group-label {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: #636e72;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        .input-group-label i {
            margin-right: 0.5rem;
            color: var(--accent);
        }

        .lang-select-wrapper {
            margin-bottom: 1.5rem;
        }

        .pdf-upload-wrapper {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .pdf-upload-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            padding: 12px;
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: #636e72;
            font-size: 0.9rem;
        }

        .pdf-upload-btn:hover {
            background: #f1f2f6;
            border-color: var(--accent);
            color: var(--accent);
        }

        #pdf-input {
            display: none;
        }

        .loader-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            z-index: 10;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #bdc3c7;
            text-align: center;
        }

        /* Translation Bar */
        #translation-bar {
            position: fixed;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%) translateY(110%);
            width: 96%;
            max-width: 1100px;
            max-height: 45vh;
            overflow-y: auto;
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-top: 5px solid var(--accent);
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -15px 50px rgba(0, 0, 0, 0.4);
            z-index: 2500;
            transition: transform 0.5s cubic-bezier(0.19, 1, 0.22, 1);
            padding: 1.5rem;
        }

        #translation-bar.show {
            transform: translateX(-50%) translateY(0);
        }

        .translation-title {
            font-size: 0.75rem;
            text-transform: uppercase;
            font-weight: 700;
            color: #636e72;
            margin-bottom: 0.25rem;
            display: block;
            letter-spacing: 0.5px;
        }

        .translation-result {
            font-size: 1.15rem;
            font-weight: 600;
            color: #2d3436;
            line-height: 1.5;
            word-wrap: break-word;
        }

        #selection-txt {
            font-family: var(--hindi-font);
            color: #4834d4;
        }

        .malayalam-text {
            font-family: var(--malayalam-font);
            color: #764ba2;
        }

        .btn-tool {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #bdc3c7;
            padding: 4px 12px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .btn-tool:hover {
            color: white;
            border-color: white;
            background: rgba(255, 255, 255, 0.05);
        }

        .loading-pulse {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #764ba2;
            border-radius: 50%;
            animation: pulse-animation 1s infinite alternate;
        }

        @keyframes pulse-animation {
            from {
                transform: scale(0.8);
                opacity: 0.4;
            }

            to {
                transform: scale(1.2);
                opacity: 1;
            }
        }

        /* Mobile specific adjustments */
        @media (max-width: 992px) {
            #sidebar {
                position: absolute;
                height: 100%;
            }

            #reader-display {
                padding: 30px 40px;
            }

            /* Toolbar Mobile Adjustments */
            .reader-toolbar {
                padding: 0 0.5rem;
            }

            #zoom-label {
                display: none;
            }

            #pdf-nav-controls {
                gap: 5px;
                padding: 0 4px !important;
            }

            #current-page-input {
                width: 38px !important;
            }

            .btn-tool {
                padding: 4px 8px;
            }
        }
    </style>
</head>

<body>

    <div id="offline-alert">
        <i class="fa-solid fa-plane"></i> Offline Mode: Translations disabled
    </div>

    <div id="app-container">
        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="sidebar-header">
                <span class="brand-text">Bhasha Buddy</span>
                <button class="btn text-white p-0" id="hide-sidebar-btn" title="Minimize Input">
                    <i class="fa-solid fa-angles-left"></i>
                </button>
            </div>
            <div class="sidebar-content">
                <!-- Source Language -->
                <div class="lang-select-wrapper">
                    <label class="input-group-label"><i class="fa-solid fa-right-to-bracket"></i> Source
                        Language</label>
                    <select id="source-lang" class="form-select form-select-sm">
                        <option value="hi" selected>Hindi (हिंदी)</option>
                        <option value="sa">Sanskrit (संस्कृतम्)</option>
                        <option value="ta">Tamil (தமிழ்)</option>
                        <option value="te">Telugu (తెలుగు)</option>
                        <option value="kn">Kannada (ಕನ್ನಡ)</option>
                        <option value="ml">Malayalam (മലയാളം)</option>
                        <option value="en">English</option>
                        <option value="fr">French (Français)</option>
                        <option value="de">German (Deutsch)</option>
                        <option value="es">Spanish (Español)</option>
                        <option value="ja">Japanese (日本語)</option>
                        <option value="auto">Detect Language (Auto)</option>
                    </select>
                </div>

                <!-- Target Languages -->
                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="input-group-label small"><i class="fa-solid fa-right-from-bracket"></i> Target
                            1</label>
                        <select id="target-lang-1" class="form-select form-select-sm">
                            <option value="ml" selected>Malayalam</option>
                            <option value="en">English</option>
                            <option value="hi">Hindi</option>
                            <option value="ta">Tamil</option>
                            <option value="te">Telugu</option>
                            <option value="fr">French</option>
                        </select>
                    </div>
                    <div class="col-6">
                        <label class="input-group-label small"><i class="fa-solid fa-right-from-bracket"></i> Target
                            2</label>
                        <select id="target-lang-2" class="form-select form-select-sm">
                            <option value="en" selected>English</option>
                            <option value="ml">Malayalam</option>
                            <option value="hi">Hindi</option>
                            <option value="ta">Tamil</option>
                            <option value="te">Telugu</option>
                            <option value="fr">French</option>
                        </select>
                    </div>
                </div>

                <!-- PDF Input -->
                <div class="pdf-upload-wrapper">
                    <label class="input-group-label"><i class="fa-solid fa-file-pdf"></i> Import from PDF</label>
                    <label for="pdf-input" class="pdf-upload-btn">
                        <i class="fa-solid fa-cloud-arrow-up me-2"></i> Choose PDF File
                    </label>
                    <input type="file" id="pdf-input" accept="application/pdf">
                    <div id="pdf-loader" class="loader-overlay">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <span class="ms-2 small">Extracting...</span>
                    </div>
                </div>

                <div class="input-group-label"><i class="fa-solid fa-keyboard"></i> Paste Text</div>
                <textarea id="hindi-input" class="form-control" placeholder="Paste your text here..."></textarea>

                <button id="update-btn" class="btn btn-primary w-100 py-3 fw-bold"
                    style="background: var(--primary-gradient); border: none;">
                    LOAD TO READER <i class="fa-solid fa-book-open ms-2"></i>
                </button>
                <div class="mt-4 p-3 bg-light rounded-3 small text-muted">
                    <i class="fa-solid fa-circle-info me-2 text-primary"></i>
                    Select text in the reader to see meanings in Malayalam and English.
                </div>
            </div>

            <!-- Footer -->
            <footer>
                <div class="container text-center">
                    <div class="social-links mb-3 justify-content-center d-flex gap-3">
                        <a href="https://github.com/Mrithul-E" target="_blank" class="social-icon" title="GitHub">
                            <i class="fab fa-github" aria-hidden="true"></i>
                        </a>
                        <a href="https://www.instagram.com/mrithull_" target="_blank" class="social-icon"
                            title="Instagram">
                            <i class="fab fa-instagram" aria-hidden="true"></i>
                        </a>
                        <a href="mailto:mrithul100@gmail.com" class="social-icon" title="Email">
                            <i class="fas fa-envelope" aria-hidden="true"></i>
                        </a>
                        <a href="https://stackoverflow.com/users/19938225/mrithul-e" target="_blank" class="social-icon"
                            title="StackOverflow">
                            <i class="fab fa-stack-overflow" aria-hidden="true"></i>
                        </a>
                        <a href="https://www.threads.net/@mrithull_" target="_blank" class="social-icon"
                            title="Threads">
                            <i class="fa-brands fa-threads" aria-hidden="true"></i>
                        </a>
                    </div>
                    <div class="mb-2">
                        <a href="https://mrithul-e.github.io/" target="_blank" class="portfolio-link">
                            <i class="fa-solid fa-briefcase me-1"></i> View Portfolio
                        </a>
                    </div>
                    <p class="text-muted mb-0"><small>© 2025 Copyright: Mrithul.E</small></p>
                </div>
            </footer>
        </aside>

        <!-- Main Reader -->
        <main id="reader-zone">
            <header class="reader-toolbar">
                <div class="d-flex align-items-center">
                    <button id="toolbar-sidebar-toggle" title="Open Sidebar">
                        <i class="fa-solid fa-bars"></i>
                    </button>
                    <span class="small text-uppercase fw-bold text-secondary me-3 d-none d-md-inline"
                        style="letter-spacing: 1px;">Document View</span>
                    <span id="lang-badge" class="badge bg-warning text-dark d-none d-sm-inline-block">Hindi &rarr;
                        Multiple</span>
                </div>

                <!-- Middle: Main Controls -->
                <div class="d-flex align-items-center gap-3">
                    <!-- PDF Navigation (Hidden by default) -->
                    <div id="pdf-nav-controls" class="d-none align-items-center bg-darker rounded px-2"
                        style="background: rgba(0,0,0,0.2);">
                        <button class="btn-tool border-0" id="prev-page-btn" title="Previous Page">
                            <i class="fa-solid fa-chevron-up"></i>
                        </button>
                        <div class="d-flex align-items-center mx-2">
                            <input type="number" id="current-page-input" value="1" min="1"
                                class="form-control form-control-sm bg-transparent text-white text-center border-secondary"
                                style="width: 45px; height: 26px; padding: 0;">
                            <span class="text-secondary mx-2">/</span>
                            <span id="total-pages-label" class="text-white small">0</span>
                        </div>
                        <button class="btn-tool border-0" id="next-page-btn" title="Next Page">
                            <i class="fa-solid fa-chevron-down"></i>
                        </button>
                    </div>

                    <!-- Zoom Controls -->
                    <div class="btn-group">
                        <button class="btn-tool" id="zoom-out-btn" title="Zoom Out"><i
                                class="fa-solid fa-minus"></i></button>
                        <div class="btn-tool border-0 text-white disabled px-3" id="zoom-label"
                            style="min-width: 65px;">
                            20px</div>
                        <button class="btn-tool" id="zoom-in-btn" title="Zoom In"><i
                                class="fa-solid fa-plus"></i></button>
                    </div>
                </div>

                <div class="d-flex align-items-center">
                    <button class="btn-tool ms-2 d-none d-sm-flex" title="Print View" onclick="window.print()"><i
                            class="fa-solid fa-print"></i></button>
                </div>
            </header>

            <div id="canvas-scroll">
                <div id="reader-display">
                    <div class="empty-state">
                        <i class="fa-solid fa-file-arrow-up fa-4x mb-4"></i>
                        <h3>Ready to Read</h3>
                        <p>Paste your text or upload a PDF in the sidebar to begin your learning session.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Translation Bar -->
    <div id="translation-bar">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <span class="badge bg-primary">Instant Translation</span>
                <button class="btn-close" id="close-trans-btn" aria-label="Close"></button>
            </div>
            <div class="row g-4">
                <div class="col-12 col-lg-4 border-end-lg">
                    <span class="translation-title">
                        Selected Selection
                        <button class="btn-speak" id="speak-btn" title="Listen to pronunciation">
                            <i class="fa-solid fa-volume-high"></i>
                        </button>
                    </span>
                    <div id="selection-txt" class="translation-result">...</div>
                </div>
                <div class="col-12 col-md-6 col-lg-4">
                    <span class="translation-title" id="target-1-label">Target 1</span>
                    <div id="target-1-result" class="translation-result">
                        <span class="loading-pulse"></span>
                    </div>
                </div>
                <div class="col-12 col-md-6 col-lg-4">
                    <span class="translation-title" id="target-2-label">Target 2</span>
                    <div id="target-2-result" class="translation-result">
                        <span class="loading-pulse"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        $(document).ready(function () {
            const cache = {};
            let fontSize = 20;
            let debounce;

            // PDF.js worker setup
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

            // --- UI Interactions ---

            // Toggle Sidebar
            $('#hide-sidebar-btn').on('click', function () {
                $('#sidebar').addClass('collapsed');
                $('#toolbar-sidebar-toggle').addClass('visible');
            });

            $('#toolbar-sidebar-toggle').on('click', function () {
                $('#sidebar').removeClass('collapsed');
                $(this).removeClass('visible');
            });

            function collapseSidebarOnMobile() {
                if (window.innerWidth <= 992) {
                    $('#sidebar').addClass('collapsed');
                    $('#toolbar-sidebar-toggle').addClass('visible');
                }
            }

            // Update Reader
            $('#update-btn').on('click', function () {
                const txt = $('#hindi-input').val().trim();
                const sourceLangName = $('#source-lang option:selected').text().split('(')[0].trim();

                if (txt) {
                    $('#reader-display').removeClass('pdf-mode').css('display', 'block').text(txt);
                    $('#lang-badge').text(`${sourceLangName} → Multiple`);
                    $('.empty-state').hide();
                    $('#pdf-nav-controls').addClass('d-none'); // Hide PDF nav
                    collapseSidebarOnMobile();
                } else {
                    $('#reader-display').css('display', 'none').empty();
                    $('.empty-state').show();
                }
            });

            // Handle Source Language Change
            $('#source-lang').on('change', function () {
                const sourceLangName = $('#source-lang option:selected').text().split('(')[0].trim();
                $('#lang-badge').text(`${sourceLangName} → Multiple`);
            });

            // PDF Handling
            $('#pdf-input').on('change', async function (e) {
                const file = e.target.files[0];
                if (!file || file.type !== 'application/pdf') return;

                $('#pdf-loader').css('display', 'flex');
                $('#reader-display').empty().addClass('pdf-mode').show();
                $('.empty-state').hide();

                try {
                    const reader = new FileReader();
                    reader.onload = async function () {
                        const typedarray = new Uint8Array(this.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;

                        $('#total-pages-label').text(pdf.numPages);
                        $('#current-page-input').val(1).attr('max', pdf.numPages);
                        $('#pdf-nav-controls').removeClass('d-none').addClass('d-flex');

                        for (let pageNum = 1; pageNum <= pdf.numPages; pageNum++) {
                            const page = await pdf.getPage(pageNum);

                            // Visual Page Wrapper
                            const wrapper = $(`<div class="pdf-page-wrapper" id="pdf-page-${pageNum}" data-page="${pageNum}"></div>`);
                            const pageBadge = $(`<div class="page-badge">PAGE ${pageNum}</div>`);
                            const container = $('<div class="pdf-page-container"></div>');

                            const viewport = page.getViewport({ scale: 1.5 });
                            const canvas = $('<canvas></canvas>')[0];
                            const context = canvas.getContext('2d');

                            canvas.height = viewport.height;
                            canvas.width = viewport.width;

                            container.append(canvas);

                            const textLayerDiv = $('<div class="textLayer"></div>')[0];
                            textLayerDiv.style.width = viewport.width + 'px';
                            textLayerDiv.style.height = viewport.height + 'px';
                            container.append(textLayerDiv);

                            wrapper.append(pageBadge).append(container);
                            $('#reader-display').append(wrapper);

                            const renderContext = { canvasContext: context, viewport: viewport };
                            await page.render(renderContext).promise;

                            const textContent = await page.getTextContent();
                            pdfjsLib.renderTextLayer({
                                textContent: textContent,
                                container: textLayerDiv,
                                viewport: viewport,
                                textDivs: []
                            });
                        }

                        $('#pdf-loader').hide();
                        updateZoom(); // Apply current zoom
                        collapseSidebarOnMobile();
                    };
                    reader.readAsArrayBuffer(file);
                } catch (err) {
                    console.error('PDF Error:', err);
                    alert('Error rendering PDF. Please try a different file.');
                    $('#pdf-loader').hide();
                }
            });

            // PDF Navigation Logic
            function scrollToPage(pageNum) {
                const target = $(`#pdf-page-${pageNum}`);
                if (target.length) {
                    $('#canvas-scroll').animate({
                        scrollTop: $('#canvas-scroll').scrollTop() + target.position().top - 20
                    }, 500);
                }
            }

            $('#current-page-input').on('change', function () {
                const val = parseInt($(this).val());
                const max = parseInt($(this).attr('max'));
                if (val >= 1 && val <= max) scrollToPage(val);
            });

            $('#prev-page-btn').on('click', () => {
                const cur = parseInt($('#current-page-input').val());
                if (cur > 1) {
                    const next = cur - 1;
                    $('#current-page-input').val(next);
                    scrollToPage(next);
                }
            });

            $('#next-page-btn').on('click', () => {
                const cur = parseInt($('#current-page-input').val());
                const max = parseInt($('#current-page-input').attr('max'));
                if (cur < max) {
                    const next = cur + 1;
                    $('#current-page-input').val(next);
                    scrollToPage(next);
                }
            });

            // Sync current page input with scroll position
            $('#canvas-scroll').on('scroll', function () {
                if (!$('#reader-display').hasClass('pdf-mode')) return;

                const scrollPos = $(this).scrollTop() + 200;
                $('.pdf-page-wrapper').each(function () {
                    const top = $(this).position().top + $('#canvas-scroll').scrollTop();
                    if (scrollPos >= top && scrollPos <= top + $(this).height()) {
                        $('#current-page-input').val($(this).data('page'));
                        return false;
                    }
                });
            });

            // Zoom Logic
            function updateZoom() {
                if ($('#reader-display').hasClass('pdf-mode')) {
                    const scale = fontSize / 20;

                    $('.pdf-page-container').css({
                        'transform': `scale(${scale})`,
                        'transform-origin': 'top center'
                    });

                    // Fix overlaps and excessive gaps: set wrapper height to the visible scaled height
                    $('.pdf-page-wrapper').each(function () {
                        const canvas = $(this).find('canvas')[0];
                        if (canvas) {
                            // Using getBoundingClientRect().height instead of canvas.height
                            // ensures we get the actual visible height after CSS scaling (max-width: 100%)
                            const visibleHeight = canvas.getBoundingClientRect().height;
                            const scaledHeight = visibleHeight + 60; // 60 for badge + margins
                            $(this).css('height', scaledHeight + 'px');
                        }
                    });

                    $('#reader-display').css('height', 'auto');
                } else {
                    const newMaxWidth = Math.min(1200, 900 + (fontSize - 20) * 8);
                    $('#reader-display').css({
                        'font-size': fontSize + 'px',
                        'max-width': newMaxWidth + 'px',
                        'height': 'auto'
                    });
                }
                $('#zoom-label').text(fontSize + 'px');
            }

            $('#zoom-in-btn').on('click', () => { if (fontSize < 50) { fontSize += 2; updateZoom(); } });
            $('#zoom-out-btn').on('click', () => { if (fontSize > 12) { fontSize -= 2; updateZoom(); } });

            // --- Translation Logic ---
            let currentSelection = "";

            $(document).on('selectionchange', function () {
                clearTimeout(debounce);
                debounce = setTimeout(processSelection, 250);
            });

            // Reliable Close Button
            $('#translation-bar').on('click', '#close-trans-btn', function (e) {
                e.preventDefault();
                e.stopPropagation();
                $('#translation-bar').removeClass('show');
                currentSelection = ""; // Reset current selection
            });

            // Offline/Online Status Handling
            function updateOnlineStatus() {
                if (navigator.onLine) {
                    $('#offline-alert').fadeOut();
                } else {
                    $('#offline-alert').css('display', 'flex').hide().fadeIn();
                }
            }

            window.addEventListener('online', updateOnlineStatus);
            window.addEventListener('offline', updateOnlineStatus);
            updateOnlineStatus();

            async function processSelection() {
                const sel = window.getSelection().toString().trim();

                if (!sel || sel.length > 500) {
                    if (!sel) {
                        $('#translation-bar').removeClass('show');
                        currentSelection = "";
                    }
                    return;
                }

                // Check for internet connection for translation
                if (!navigator.onLine) {
                    alert("⚠️ Translation requires an internet connection. Please check your network.");
                    return;
                }

                // Don't restart if selection hasn't changed
                if (sel === currentSelection) return;
                currentSelection = sel;

                const sl = $('#source-lang').val();
                const tl1 = $('#target-lang-1').val();
                const tl2 = $('#target-lang-2').val();

                // Update Labels
                $('#target-1-label').text($('#target-lang-1 option:selected').text());
                $('#target-2-label').text($('#target-lang-2 option:selected').text());

                // Show bar and loaders
                $('#selection-txt').text(sel);
                $('#target-1-result, #target-2-result').html('<span class="loading-pulse"></span>');

                // Ensure the translation bar shows up correctly
                setTimeout(() => {
                    $('#translation-bar').addClass('show');
                }, 50);

                try {
                    const results = await getTranslations(sel, sl, tl1, tl2);

                    // Only apply if the selection hasn't changed while waiting
                    if (currentSelection === sel) {
                        $('#target-1-result').text(results.t1);
                        $('#target-2-result').text(results.t2);

                        // Add Malayalam font class if target is Malayalam
                        $('#target-1-result').toggleClass('malayalam-text', tl1 === 'ml');
                        $('#target-2-result').toggleClass('malayalam-text', tl2 === 'ml');
                    }
                } catch (e) {
                    if (currentSelection === sel) {
                        $('#target-1-result, #target-2-result').html('<span class="text-danger small">Error</span>');
                    }
                }
            }

            async function getTranslations(q, sl, tl1, tl2) {
                const cacheKey1 = `${sl}:${tl1}:${q}`;
                const cacheKey2 = `${sl}:${tl2}:${q}`;

                const [res1, res2] = await Promise.all([
                    cache[cacheKey1] ? Promise.resolve(cache[cacheKey1]) : fetchGT(q, sl, tl1),
                    cache[cacheKey2] ? Promise.resolve(cache[cacheKey2]) : fetchGT(q, sl, tl2)
                ]);

                cache[cacheKey1] = res1;
                cache[cacheKey2] = res2;

                return { t1: res1, t2: res2 };
            }

            // --- Speech Synthesis ---
            function speakText(text, lang) {
                if (!('speechSynthesis' in window)) {
                    alert("Sorry, your browser doesn't support text to speech.");
                    return;
                }

                // Stop any current speech
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);

                // Map Bhasha-Buddy codes to SpeechSynthesis codes
                const langMap = {
                    'hi': 'hi-IN',
                    'en': 'en-US',
                    'fr': 'fr-FR',
                    'de': 'de-DE',
                    'es': 'es-ES',
                    'ja': 'ja-JP',
                    'ta': 'ta-IN',
                    'te': 'te-IN',
                    'ml': 'ml-IN',
                    'kn': 'kn-IN'
                };

                utterance.lang = langMap[lang] || lang;
                utterance.rate = 0.9; // Slightly slower for better learning
                window.speechSynthesis.speak(utterance);
            }

            $('#speak-btn').on('click', function () {
                const text = $('#selection-txt').text();
                const lang = $('#source-lang').val();
                if (text && text !== "...") {
                    speakText(text, lang);
                }
            });

            async function fetchGT(q, sl, tl) {
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=${sl}&tl=${tl}&dt=t&q=${encodeURIComponent(q)}`;
                const response = await fetch(url);
                const data = await response.json();
                return data[0].map(x => x[0]).join('');
            }

            // Register Service Worker for PWA
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(reg => {
                            console.log('Service Worker registered');
                            reg.addEventListener('updatefound', () => {
                                const newWorker = reg.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        console.log('New update available, reloading...');
                                    }
                                });
                            });
                        })
                        .catch(err => console.log('Service Worker failed', err));
                });

                let refreshing = false;
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    if (!refreshing) {
                        window.location.reload();
                        refreshing = true;
                    }
                });
            }
        });
    </script>
</body>

</html>